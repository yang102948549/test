<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>전자 서명</title>
  <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap');

    body {
      font-family: 'Noto Sans KR', sans-serif;
      background-color: #f4f7f6;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      margin: 0;
      color: #333;
    }

    .signature-container {
      background: #ffffff;
      padding: 40px;
      border-radius: 12px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
      width: 100%;
      max-width: 500px;
      text-align: center;
    }

    h1 {
      font-weight: 700;
      margin-bottom:  30px;
      color: #2c3e50;
    }

    .input-group {
      margin-bottom: 25px;
      text-align: left;
    }

    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: #555;
    }

    #nameInput {
      width: 100%;
      padding: 12px;
      border: 1px solid #ccc;
      border-radius: 6px;
      box-sizing: border-box;
      font-size: 16px;
    }

    #signature-pad {
      border: 2px dashed #e0e0e0;
      border-radius: 6px;
      cursor: crosshair;
      width: 100%;
      height: 200px;
    }

    .button-group {
      margin-top: 20px;
      display: flex;
      gap: 10px;
    }

    button {
      flex: 1;
      padding: 15px 20px;
      border: none;
      border-radius: 6px;
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      transition: background-color 0.3s ease, transform 0.2s ease;
    }

    #clearBtn {
      background-color: #7f8c8d;
      color: white;
    }

    #clearBtn:hover {
      background-color: #95a5a6;
      transform: translateY(-2px);
    }

    #submitBtn {
      background-color: #3498db;
      color: white;
    }

    #submitBtn:hover {
      background-color: #2980b9;
      transform: translateY(-2px);
    }

    @media (max-width: 600px) {
      .signature-container {
        padding: 20px;
        margin: 20px;
      }

      h1 {
        font-size: 24px;
      }
    }
  </style>
</head>
<body>
  <div class="signature-container">
    <h1>전자 서명</h1>

    <div class="input-group">
      <label for="nameInput">성함</label>
      <input type="text" id="nameInput" placeholder="이름을 입력하세요" />
    </div>

    <div class="input-group">
      <label>서명란</label>
      <canvas id="signature-pad"></canvas>
    </div>

    <div class="button-group">
      <button id="clearBtn">다시 쓰기</button>
      <button id="submitBtn">제출하기</button>
    </div>
  </div>

  <script>
    // 이 URL이 위에서 확인한 GAS 배포 URL과 정확히 일치해야 합니다.
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzA9KEPSiSk3cpZaxuEGzEtwzgAIlyww2ZGqMFO9hL82ABKRk_adqlWxsC8NMIscAvnkg/exec";

    const canvas = document.getElementById('signature-pad');
    const ratio = Math.max(window.devicePixelRatio || 1, 1);
    canvas.width = canvas.offsetWidth * ratio;
    canvas.height = canvas.offsetHeight * ratio;
    canvas.getContext("2d").scale(ratio, ratio);

    const signaturePad = new SignaturePad(canvas);
    const clearBtn = document.getElementById('clearBtn');
    const submitBtn = document.getElementById('submitBtn');
    const nameInput = document.getElementById('nameInput');

    clearBtn.addEventListener('click', () => {
      signaturePad.clear();
    });

    submitBtn.addEventListener('click', async () => {
      const name = nameInput.value.trim();

      if (signaturePad.isEmpty() || name === "") {
        alert("이름과 서명을 모두 입력해주세요.");
        return;
      }

      const signatureImage = signaturePad.toDataURL("image/png");

      try {
        const response = await fetch(SCRIPT_URL, {
          method: 'POST',
          mode: 'cors',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded'
          },
          body: `childName=${encodeURIComponent(name)}&imageDataUrl=${encodeURIComponent(signatureImage)}`
        });

        // 응답 상태 코드 확인
        if (!response.ok) {
          const errorText = await response.text(); // 서버 응답 본문을 텍스트로 읽어봅니다.
          console.error("HTTP error! Status:", response.status, "Response text:", errorText);
          alert(`서버 응답 오류: ${response.status}. 자세한 내용은 콘솔을 확인해주세요.`);
          return;
        }

        const result = await response.json();

        if (result.status === "success") {
          alert("서명이 성공적으로 제출되었습니다!\n파일 ID: " + result.fileId + "\n스프레드시트 URL: " + result.sheetUrl);
          signaturePad.clear();
          nameInput.value = "";
        } else {
          alert("서명 제출 실패: " + result.message);
          console.error("서버 응답 오류:", result.message, result.detail || "");
        }
      } catch (error) {
        alert("네트워크 오류 또는 서버 통신 실패: " + error.message);
        console.error("Fetch 오류:", error);
      }
    });

    window.addEventListener("resize", () => {
      const ratio = Math.max(window.devicePixelRatio || 1, 1);
      canvas.width = canvas.offsetWidth * ratio;
      canvas.height = canvas.offsetHeight * ratio;
      canvas.getContext("2d").scale(ratio, ratio);
      signaturePad.clear(); // 캔버스 크기 변경 시 서명 초기화
    });
  </script>
</body>
</html>
