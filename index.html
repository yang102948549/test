<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>전자 서명</title>
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap');

        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: #f4f7f6;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            color: #333;
        }

        .signature-container {
            background: #ffffff;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 500px;
            text-align: center;
        }

        h1 {
            font-weight: 700;
            margin-bottom: 30px;
            color: #2c3e50;
        }

        .input-group {
            margin-bottom: 25px;
            text-align: left;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #555;
        }

        #nameInput {
            width: 100%;
            padding: 12px;
            border: 1px solid #ccc;
            border-radius: 6px;
            box-sizing: border-box;
            font-size: 16px;
        }

        #signature-pad {
            border: 2px dashed #e0e0e0;
            border-radius: 6px;
            cursor: crosshair;
            width: 100%;
            height: 200px;
        }

        .button-group {
            margin-top: 20px;
            display: flex;
            gap: 10px;
        }
        
        button {
            flex: 1;
            padding: 15px 20px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
        }

        #clearBtn {
            background-color: #7f8c8d;
            color: white;
        }

        #clearBtn:hover {
            background-color: #95a5a6;
            transform: translateY(-2px);
        }

        #submitBtn {
            background-color: #3498db;
            color: white;
        }

        #submitBtn:hover {
            background-color: #2980b9;
            transform: translateY(-2px);
        }

        @media (max-width: 600px) {
            .signature-container {
                padding: 20px;
                margin: 20px;
            }
            h1 {
                font-size: 24px;
            }
        }
    </style>
</head>
<body>

    <div class="signature-container">
        <h1>전자 서명</h1>
        
        <div class="input-group">
            <label for="nameInput">성함</label>
            <input type="text" id="nameInput" placeholder="이름을 입력하세요">
        </div>
        
        <div class="input-group">
            <label>서명란</label>
            <canvas id="signature-pad"></canvas>
        </div>
        
        <div class="button-group">
            <button id="clearBtn">다시 쓰기</button>
            <button id="submitBtn">제출하기</button>
        </div>
    </div>

    <script>
        // !!! 중요: Google Apps Script 웹 앱으로 배포한 후 얻은 URL을 여기에 붙여넣으세요!
        // 예: const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzzzzzzzzzzzzzzzzzzzzzzzzzz/exec";
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwH2NUjz2jzraEd82fo9gHzWiX5NmNs236yRBllYfAJfGwXpdo6K6J7qrq6BT2qF4i9-g/exec"; 

        const canvas = document.getElementById('signature-pad');
        // 캔버스 해상도 조정을 위한 ratio 계산. 고해상도 화면에서 서명이 깨지지 않도록 합니다.
        const ratio = Math.max(window.devicePixelRatio || 1, 1);
        canvas.width = canvas.offsetWidth * ratio;
        canvas.height = canvas.offsetHeight * ratio;
        canvas.getContext("2d").scale(ratio, ratio);

        const signaturePad = new SignaturePad(canvas);

        const clearBtn = document.getElementById('clearBtn');
        const submitBtn = document.getElementById('submitBtn');
        const nameInput = document.getElementById('nameInput');

        // '다시 쓰기' 버튼 클릭 시 서명 초기화
        clearBtn.addEventListener('click', () => {
            signaturePad.clear();
        });

        // '제출하기' 버튼 클릭 시 서명 및 이름 데이터 전송
        submitBtn.addEventListener('click', async () => { // 비동기 함수로 변경
            const name = nameInput.value.trim(); // 이름 입력 값 가져오기

            // 이름 또는 서명이 비어있는지 확인
            if (signaturePad.isEmpty() || name === "") {
                alert("이름과 서명을 모두 입력해주세요.");
                return; // 함수 실행 중단
            }

            // 서명 이미지를 PNG 형식의 Data URL로 변환
            const signatureImage = signaturePad.toDataURL("image/png");

            // Google Apps Script 웹 앱으로 데이터 전송 시작
            try {
                // fetch API를 사용하여 POST 요청 전송
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST', // POST 메소드 사용
                    mode: 'cors',    // CORS 정책 준수 (교차 출처 요청 허용)
                    headers: {
                        'Content-Type': 'application/json' // JSON 형식으로 데이터 전송 명시
                    },
                    // body에 JSON 형태로 이름과 서명 이미지 데이터 URL 포함
                    body: JSON.stringify({
                        childName: name,      // Apps Script에서 'childName'으로 받을 이름
                        imageDataUrl: signatureImage // Apps Script에서 'imageDataUrl'로 받을 서명 이미지
                    })
                });

                // 서버(Apps Script)로부터의 응답을 JSON 형태로 파싱
                const result = await response.json();

                // 응답 결과에 따라 사용자에게 알림
                if (result.status === "success") {
                    alert("서명이 성공적으로 제출되었습니다!\n파일 ID: " + result.fileId + "\n스프레드시트 URL: " + result.sheetUrl);
                    signaturePad.clear(); // 제출 성공 시 서명 초기화
                    nameInput.value = ""; // 이름 입력 필드 초기화
                } else {
                    // 서버에서 오류 응답을 보냈을 경우
                    alert("서명 제출 실패: " + result.message);
                    console.error("서버 응답 오류:", result.message); // 개발자 도구에 상세 오류 로깅
                }
            } catch (error) {
                // 네트워크 오류 (예: 인터넷 연결 끊김, SCRIPT_URL 오타 등) 발생 시
                alert("네트워크 오류 또는 서버 통신 실패: " + error.message);
                console.error("Fetch 오류:", error); // 개발자 도구에 상세 오류 로깅
            }
        });

        // 창 크기 변경 시 캔버스 해상도 재조정 및 서명 초기화 (캔버스 비율 유지)
        window.addEventListener("resize", () => {
            const ratio = Math.max(window.devicePixelRatio || 1, 1);
            canvas.width = canvas.offsetWidth * ratio;
            canvas.height = canvas.offsetHeight * ratio;
            canvas.getContext("2d").scale(ratio, ratio);
            signaturePad.clear(); // 서명 다시 그리도록 초기화
        });
    </script>

</body>
</html>
